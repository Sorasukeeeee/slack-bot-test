name: Check Commit Check Suites

on:
  push:
    branches:
      - main  # メインブランチにコミットされたときに実行

jobs:
  check_commit_suites:
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v2

    - name: Get latest commit SHA
      id: commit_sha
      run: echo "::set-output name=sha::$(git log -1 --format='%H')"

    - name: Get check suites
      id: get_check_suites
      run: |
        commit_sha="${{ steps.commit_sha.outputs.sha }}"
        api_url="https://api.github.com/repos/${{ github.repository }}/commits/${commit_sha}/check-suites"
        check_suites_json="$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" $api_url)"
        echo "::set-output name=check_suites::${check_suites_json}"

    - name: Check for failures
      run: |
        check_suites="${{ steps.get_check_suites.outputs.check_suites }}"
        failures="$(echo $check_suites | jq '.check_suites[] | select(.conclusion == "failure")')"
        if [ -n "$failures" ]; then
          echo "Failures found in check suites!"
          exit 1
        else
          echo "No failures found in check suites."
        fi
