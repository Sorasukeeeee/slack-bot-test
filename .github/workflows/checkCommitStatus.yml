name: Check Latest Commit Status

on:
  issue_comment:
    types: [created]

jobs:
  check-commit-status:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR Branch
      run: git checkout ${{ github.head_ref }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Get Latest Commit SHA
      id: commit_sha
      run: |
        echo "COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Get Check Suites
      id: check_suites
      run: |
        CHECK_SUITES_RESPONSE=$(curl -s "https://api.github.com/repos/${{ github.repository }}/commits/${{ env.COMMIT_SHA }}/check-suites")
        CONCLUSIONS=($(echo $CHECK_SUITES_RESPONSE | jq -r '.check_suites[].conclusion'))
        echo "Conclusions: ${CONCLUSIONS[*]}"
        for CONCLUSION in "${CONCLUSIONS[@]}"; do
          if [ "$CONCLUSION" == "failure" ]; then
            echo "There is a failed check suite."
            exit 1
          fi
        done
        echo "No failed check suites."
